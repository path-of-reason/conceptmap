# 📄 Note 데이터모델 & KuzuDB 스키마 상세 설계서


## 1. Note데이터 모델 정의 (Rust Struct / Typescript Interface)

### 1.1. 필수 필드 정의

| 필드명         | 타입        | 설명                                         | 비고         |
|:---------------|:-----------|:---------------------------------------------|:-------------|
| uuid           | string     | 불변, 영구 식별자 (PK, UUID v4 등)           | 파일명/DB Key |
| title          | string     | 노트 제목                                   |              |
| content        | string     | 마크다운 본문                               |              |
| created_at     | datetime   | 생성 일시                                   | ISO8601/RFC3339 |
| updated_at     | datetime   | 최근 수정 일시                              |              |
| rank           | string     | 정렬/삽입 순서(예: LexoRank 키)             |              |
| parent_uuid    | string/null| 부모노트 uuid (루트면 null)                 | 트리 계층 연결 |
| file_path      | string     | 실제 파일물리경로                           | 필요시        |
| display_id     | string     | 계층 번호(1, 1.2 등, 계산 or 부분캐시)       | API출력 only  |

#### Typescript 예시
```ts
export interface Note {
  uuid: string;
  title: string;
  content: string;
  createdAt: string;
  updatedAt: string;
  rank: string;
  parentUuid: string | null;
  filePath: string;
  displayId?: string; // API 출력용
}
```

#### Rust Struct 예시
```rust
pub struct Note {
    pub uuid: String,
    pub title: String,
    pub content: String,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
    pub rank: String,
    pub parent_uuid: Option<String>,
    pub file_path: String
}
```


## 2. KuzuDB 스키마 (테이블/그래프 구조)

### 2.1. 노드 정의
```sql
CREATE NODE TABLE Note (
    uuid STRING PRIMARY KEY,
    title STRING,
    content STRING,
    created_at DATETIME,
    updated_at DATETIME,
    rank STRING,
    parent_uuid STRING,
    file_path STRING
);
```

### 2.2. 관계(Relation) 정의

| 관계명    | FROM         | TO           | 설명                    |
|-----------|--------------|--------------|-------------------------|
| CHILD_OF  | Note(uuid)   | Note(uuid)   | 자식→부모 관계(1:N)     |
| NEXT      | Note(uuid)   | Note(uuid)   | 형제간 순서 연결        |

```sql
-- Child(자식) → Parent(부모)
CREATE REL TABLE ChildOf (
    FROM Note TO Note
);

-- Prev(이전) → Next(다음) 형제
CREATE REL TABLE Next (
    FROM Note TO Note
);

-- (확장용 Tag, Link 등 추가 가능)
```

### 2.3. 인덱스/제약조건

```sql
CREATE INDEX ON Note(rank);
CREATE INDEX ON Note(parent_uuid);
-- rank+parent_uuid 복합 인덱스 권장(빠른 조회)
```


## 3. 샘플 데이터 예시

### 3.1. Note JSON
```json
{
  "uuid": "a1b2c3d4",
  "title": "제텔카스텐 시작",
  "content": "이것은 첫 루만식 노트입니다.",
  "createdAt": "2025-08-24T04:20:00Z",
  "updatedAt": "2025-08-24T04:21:15Z",
  "rank": "U",
  "parentUuid": null,
  "filePath": "/Users/xx/Notes/a1b2c3d4.md",
  "displayId": "1"
}
```

### 3.2. 관계
| from (uuid) | to (uuid) | type    |
|-------------|-----------|---------|
| a2b2...     | a1b2...   | CHILD_OF|
| a3b3...     | a2b2...   | NEXT    |


## 4. 처리/동기화/넘버링 정책

- **저장 정책**  
  - 노트 생성 시 파일(YAML+MD)+DB 노드 동시 생성  
  - 부모 uuid, rank, 파일경로 등은 필수 관리  
  - 관계(ChildOf, Next)도 즉시 연결
- **displayId**  
  - DB에 저장X, API 응답시 계산해 포함(부분 캐시/국소 업데이트 정책 허용)
- **파일명**  
  - uuid.md 권장, YAML에 uuid/meta 추가
- **삭제/이동 시**  
  - 관계, 자식연결, 형제 연결 등 그래프 형태 update  
- **동기화**  
  - 파일→DB ingest는 후순위(외부수정/마이그레이션용)  
  - 노트 생성/편집/삭제시 DB/파일 항상 동기화


## 5. Principal Considerations(구현 체크리스트)

- uuid 등 영구불변 PK
- parent/child/next 관계 불변성 관리(루트/계층 확인)
- rank는 LexoRank 등 사전식 정렬키(중간삽입/이동 최적화)
- created_at/updated_at tracking
- displayId는 계산/캐시일 뿐(관계/컬렉션 쿼리 기준)
- 파일/DB 필드/값 타입 일치, Path 불일치 자동 감지
- 데이터 마이그레이션시 JSON 구조→YAML+MD, or DB→MD, MD→DB auto mapping 지원 설계

### (필요하면 Tag, Backlink 등 확장 구조/스키마/미래 설계안, API 인터페이스 예시, 쿼리/REST/GraphQL 등도 추가 안내 가능!)

**이 문서를 바탕으로 실제 데이터모델/스키마/동기화 코드를 설계하시면,**  
모든 노트 생성-저장-트리화-동기화의 근거문서,  
개발/테스트/협업 기준서가 될 수 있습니다!

필요 시 DB쿼리/Graph 탐색/예시 운영코드, API/프론트 연결 내용 등  
더 세분화해서 지원 가능합니다.  
(확장 구조, Migration, 외부 연동 등 특별사례 가능)
