# 온톨로지: `kuzudb::commands`

## 1. 핵심 개념

`kuzudb::commands` 모듈은 프론트엔드(Svelte)와 백엔드(Rust) 간의 인터페이스 역할을 하는 Tauri 커맨드를 정의합니다. `#[tauri::command]` 어트리뷰트를 통해 Rust 함수를 프론트엔드에서 호출 가능한 API로 노출시킵니다.

- **프론트엔드 인터페이스**: `create_note`, `get_all_notes`와 같은 함수를 정의하여, 프론트엔드의 요청에 따라 데이터베이스 작업을 수행합니다.
- **상태 접근**: Tauri의 `State` 관리 기능을 통해, `KuzuDB`와 같은 전역 상태에 안전하게 접근하여 데이터베이스 핸들러를 사용합니다.
- **데이터 변환 및 처리**: 단순 DB 조회를 넘어, `get_all_notes`의 경우처럼 DB에서 읽어온 데이터를 프론트엔드가 사용하기 좋은 형태(계층 구조 포함)로 가공하여 반환하는 로직을 포함합니다.

## 2. 활용처 (Usage)

- **노트 목록 조회**: 프론트엔드에서 앱이 시작되거나 데이터 갱신이 필요할 때, `invoke('get_all_notes')`를 호출하여 전체 노트 목록을 가져옵니다.
- **노트 생성**: 프론트엔드에서 사용자가 새 노트 생성을 요청하면, `invoke('create_note', { ... })`를 호출합니다.
- **`lib.rs` 등록**: `tauri::Builder`의 `invoke_handler`에 `create_note`, `get_all_notes` 함수가 등록되어야 프론트엔드에서 호출할 수 있습니다.

## 3. 메뉴얼

### `get_all_notes` 커맨드

DB에 저장된 모든 노트를 프론트엔드가 렌더링하기 적합한 계층 구조의 플랫 리스트(flat list)로 변환하여 반환합니다.

1.  **데이터 조회**: `db.get_all_notes_with_relationships()`를 호출하여 모든 `Note` 노드와 `ChildOf` 관계를 가져옵니다.
2.  **인메모리 트리 구성**: 가져온 데이터를 기반으로 메모리 상에서 부모-자식 관계를 나타내는 트리를 구성합니다. 각 레벨의 자식 노드들은 `rank` 순서에 따라 정렬됩니다.
3.  **DFS 탐색 및 플랫 리스트 생성**: 구성된 트리를 깊이 우선 탐색(DFS) 방식으로 순회하면서 최종적으로 반환될 플랫 리스트를 생성합니다.
4.  **계층 정보 추가**: 탐색 과정에서 각 노트의 깊이(`level`)와 화면에 표시될 ID(`display_id`, 예: "1.2.1")를 계산하여 `NoteWithHierarchy` 객체에 담아 반환합니다.

### `create_note` 커맨드

이 함수는 새로운 노트를 생성하는 전체 과정을 담당합니다.

1.  **데이터 생성**: `uuid`, `rank`, 타임스탬프 등 노트에 필요한 메타데이터를 생성합니다.
2.  **`Note` 인스턴스화**: 전달받은 인자와 생성된 메타데이터를 사용하여 `kuzudb::models::Note` 구조체 인스턴스를 만듭니다.
3.  **DB 노드 생성**: `db.insert_note()`를 호출하여 데이터베이스에 `Note` 노드를 추가합니다.
4.  **관계 생성**: 만약 `parent_uuid`가 존재하면, `ChildOf` 관계를 생성하여 새로운 노드를 부모 노드에 연결합니다.

## 4. 변경 이력

- **25.08.28**:
    - `get_all_notes` Tauri 커맨드 추가.
    - DB 데이터를 DFS로 순회하여 계층 정보를 포함한 플랫 리스트를 생성하는 로직 구현.
- **25.08.26 (재확인)**:
    - `02.plan.note-creation-api.md` 계획에 따라 재검토.
    - 파일 저장, 노드 및 관계 생성 로직이 상세 계획과 일치함을 확인.
- **25.08.26**:
    - `create_note` Tauri 커맨드 구현.
    - 파일 시스템에 `.md` 파일을 생성하고, KuzuDB에 `Note` 노드와 `ChildOf` 관계를 추가하는 로직 통합.